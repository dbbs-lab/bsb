name: Test examples
on:
  pull_request:
    types: [ opened, synchronize, reopened, review_requested ]

jobs:
  find_examples:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.list-examples.outputs.folders }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: list-examples
        run: |
          # find folders inside the example folder
          folders=$(find examples -maxdepth 1 -mindepth 1 -type d)
          echo "folders=$folders" >> $GITHUB_OUTPUT
  
  test_examples:
    needs: [ find_examples ]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        folder: ${{ fromJSON(needs.find_examples.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install apt dependencies
        run: |
          sudo apt update
          sudo apt install libhdf5-dev

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Run unittests
        run: |
          cd ${{ matrix.folder }}
          uv sync
          uv run python -m unittest discover -v -s tests
        env:
          UV_PYTHON: 3.12
